<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>éº¥å‘³ç™»æ™ºå–æ«ƒ - è¨‚å–®æŸ¥è©¢ç³»çµ±</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      /* éº¥å‘³ç™»å®˜æ–¹å“ç‰Œè‰² */
      --mwd-green: #154733;
      --mwd-green-light: #1b5b41;
      --mwd-green-dark: #0f3325;
      --mwd-green-bg: #e8f5e9;
      --mwd-coral: #e36159;
      --mwd-coral-light: #e7766f;
      --mwd-teal: #2baab1;
      --mwd-dark: #2e353e;
      --mwd-gray: #666666;
      --mwd-gray-light: #F5F5F5;
      --mwd-white: #FFFFFF;
      --shadow: 0 2px 8px rgba(0,0,0,0.1);
      --shadow-hover: 0 4px 16px rgba(21,71,51,0.3);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Noto Sans TC', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: var(--mwd-gray-light);
      color: #333;
      line-height: 1.6;
      min-height: 100vh;
    }

    /* é ‚éƒ¨å°èˆª */
    .navbar {
      background: var(--mwd-green);
      box-shadow: var(--shadow);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .navbar-inner {
      max-width: 1400px;
      margin: 0 auto;
      padding: 12px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 15px;
      text-decoration: none;
    }

    .logo img {
      height: 50px;
      width: auto;
    }

    .logo-text {
      display: flex;
      flex-direction: column;
      color: var(--mwd-white);
    }

    .logo-title {
      font-size: 1.1rem;
      font-weight: 700;
    }

    .logo-subtitle {
      font-size: 0.75rem;
      opacity: 0.85;
    }

    .navbar-time {
      font-size: 0.9rem;
      color: var(--mwd-white);
      opacity: 0.9;
    }

    .navbar-slogan {
      color: var(--mwd-white);
      font-size: 0.85rem;
      opacity: 0.9;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 24px 20px;
    }

    /* æœå°‹å¡ç‰‡ */
    .search-card {
      background: var(--mwd-white);
      border-radius: 12px;
      box-shadow: var(--shadow);
      margin-bottom: 24px;
      overflow: hidden;
    }

    .search-header {
      background: var(--mwd-green);
      color: white;
      padding: 14px 24px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .search-header h2 {
      font-size: 1rem;
      font-weight: 500;
    }

    .search-body {
      padding: 24px;
    }
    
    .search-form {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 16px;
      align-items: end;
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    
    .form-group label {
      font-size: 0.85rem;
      color: var(--mwd-gray);
      font-weight: 500;
    }
    
    .form-group input, .form-group select {
      padding: 11px 14px;
      border: 2px solid #E0E0E0;
      border-radius: 8px;
      font-size: 0.95rem;
      font-family: inherit;
      transition: all 0.2s;
    }
    
    .form-group input:focus, .form-group select:focus {
      outline: none;
      border-color: var(--mwd-green);
      box-shadow: 0 0 0 3px var(--mwd-green-bg);
    }

    .form-group input::placeholder {
      color: #BDBDBD;
    }

    .time-select {
      margin-top: 8px;
    }
    
    .btn {
      padding: 11px 24px;
      border: none;
      border-radius: 8px;
      font-size: 0.95rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-primary {
      background: var(--mwd-green);
      color: white;
    }
    
    .btn-primary:hover {
      background: var(--mwd-green-light);
      transform: translateY(-1px);
      box-shadow: var(--shadow-hover);
    }
    
    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .btn-secondary {
      background: var(--mwd-gray-light);
      color: var(--mwd-gray);
      border: 1px solid #ddd;
    }

    .btn-secondary:hover {
      background: #E8E8E8;
    }

    /* çµæœå¡ç‰‡ */
    .result-card {
      background: var(--mwd-white);
      border-radius: 12px;
      box-shadow: var(--shadow);
      margin-bottom: 24px;
      overflow: hidden;
      display: none;
    }

    .result-card.active {
      display: block;
    }

    .result-header {
      padding: 14px 24px;
      border-bottom: 1px solid #F0F0F0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 12px;
    }

    .result-header h2 {
      font-size: 1rem;
      font-weight: 600;
      color: var(--mwd-green);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .result-body {
      padding: 0;
    }

    /* çµ±è¨ˆæ¨™ç±¤ */
    .stats-bar {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .stat-tag {
      padding: 5px 12px;
      border-radius: 16px;
      font-size: 0.8rem;
      font-weight: 500;
    }

    .stat-tag.total {
      background: var(--mwd-green-bg);
      color: var(--mwd-green);
    }

    .stat-tag.complete {
      background: #E3F2FD;
      color: var(--mwd-teal);
    }

    .stat-tag.incomplete {
      background: #FFEBEE;
      color: var(--mwd-coral);
    }
    
    /* è¨‚å–®è¡¨æ ¼ */
    .order-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .order-table th, .order-table td {
      padding: 12px 20px;
      text-align: left;
      border-bottom: 1px solid #F0F0F0;
    }
    
    .order-table th {
      background: #FAFAFA;
      font-weight: 600;
      color: var(--mwd-gray);
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .order-table tr:hover {
      background: var(--mwd-green-bg);
    }
    
    .order-link {
      color: var(--mwd-green);
      text-decoration: none;
      font-weight: 600;
      cursor: pointer;
      transition: color 0.2s;
    }
    
    .order-link:hover {
      color: var(--mwd-green-light);
      text-decoration: underline;
    }
    
    /* æ¨™ç±¤ */
    .badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 500;
    }
    
    .badge.store {
      background: var(--mwd-green-bg);
      color: var(--mwd-green);
    }
    
    .badge.token {
      background: #E3F2FD;
      color: #1565C0;
    }
    
    .badge.chid {
      background: #FFF8E1;
      color: #F57C00;
    }
    
    .badge.complete {
      background: #E0F7FA;
      color: var(--mwd-teal);
    }
    
    .badge.incomplete {
      background: #FFEBEE;
      color: var(--mwd-coral);
    }

    /* è¨‚å–®è©³æƒ… */
    .detail-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 24px;
      border-bottom: 1px solid #F0F0F0;
      flex-wrap: wrap;
      gap: 16px;
    }
    
    .detail-title {
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--mwd-green);
    }
    
    .detail-meta {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    /* æ™‚é–“è»¸ */
    .timeline-container {
      padding: 24px;
    }

    .timeline {
      position: relative;
      padding-left: 32px;
    }
    
    .timeline::before {
      content: '';
      position: absolute;
      left: 10px;
      top: 0;
      bottom: 0;
      width: 3px;
      background: linear-gradient(to bottom, var(--mwd-green), var(--mwd-teal));
      border-radius: 3px;
    }
    
    .timeline-gap {
      position: relative;
      padding: 4px 0 4px 32px;
      font-size: 0.7rem;
      color: #999;
      font-family: monospace;
    }
    
    .timeline-gap::before {
      content: '';
      position: absolute;
      left: 8px;
      top: 50%;
      width: 7px;
      height: 7px;
      background: #ddd;
      border-radius: 50%;
      transform: translateY(-50%);
    }
    
    .timeline-item {
      position: relative;
      padding-bottom: 18px;
    }
    
    .timeline-item:last-child {
      padding-bottom: 0;
    }
    
    .timeline-dot {
      position: absolute;
      left: -28px;
      top: 6px;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: var(--mwd-green);
      border: 3px solid white;
      box-shadow: 0 0 0 2px var(--mwd-green);
    }
    
    .timeline-dot.storer {
      background: var(--mwd-teal);
      box-shadow: 0 0 0 2px var(--mwd-teal);
    }
    
    .timeline-dot.retriever {
      background: var(--mwd-coral);
      box-shadow: 0 0 0 2px var(--mwd-coral);
    }
    
    .timeline-dot.cabin {
      background: #FF9800;
      box-shadow: 0 0 0 2px #FF9800;
    }
    
    .timeline-content {
      background: var(--mwd-gray-light);
      padding: 12px 16px;
      border-radius: 8px;
      border-left: 3px solid var(--mwd-green);
    }

    .timeline-content.storer {
      border-left-color: var(--mwd-teal);
    }

    .timeline-content.retriever {
      border-left-color: var(--mwd-coral);
    }
    
    .timeline-content.cabin {
      border-left-color: #FF9800;
      background: #FFF8E1;
    }
    
    .timeline-time {
      font-size: 0.75rem;
      color: var(--mwd-gray);
      margin-bottom: 4px;
    }
    
    .timeline-event {
      font-weight: 600;
      font-size: 0.9rem;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    .timeline-event .device {
      font-size: 0.7rem;
      padding: 2px 6px;
      border-radius: 3px;
      font-weight: 500;
    }
    
    .timeline-event .device.storer {
      background: #E0F7FA;
      color: var(--mwd-teal);
    }
    
    .timeline-event .device.retriever {
      background: #FFEBEE;
      color: var(--mwd-coral);
    }
    
    .timeline-state {
      font-size: 0.7rem;
      color: #999;
      margin-top: 4px;
      font-family: monospace;
    }
    
    /* ç‹€æ…‹è¨Šæ¯ */
    .message {
      padding: 40px;
      text-align: center;
      color: var(--mwd-gray);
    }

    .message.loading {
      color: var(--mwd-green);
    }
    
    .message.error {
      padding: 20px;
      background: #FFEBEE;
      color: var(--mwd-coral);
      border-radius: 8px;
      margin: 20px;
    }

    /* Footer */
    .footer {
      text-align: center;
      padding: 20px;
      color: var(--mwd-gray);
      font-size: 0.8rem;
    }

    .footer a {
      color: var(--mwd-green);
      text-decoration: none;
    }

    /* éŸ¿æ‡‰å¼ */
    @media (max-width: 768px) {
      .search-form {
        grid-template-columns: 1fr;
      }

      .navbar-slogan {
        display: none;
      }

      .logo img {
        height: 40px;
      }
      
      .order-table {
        font-size: 0.85rem;
      }
      
      .order-table th, .order-table td {
        padding: 10px 12px;
      }

      .detail-header {
        flex-direction: column;
        align-items: flex-start;
      }
    }

    /* å‹•ç•« */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .result-card.active {
      animation: fadeIn 0.3s ease;
    }
  </style>
</head>
<body>
  <!-- å°èˆªåˆ— -->
  <nav class="navbar">
    <div class="navbar-inner">
      <a href="#" class="logo">
        <img src="logo.png" alt="éº¥å‘³ç™»">
        <div class="logo-text">
          <span class="logo-title">æ™ºå–æ«ƒç³»çµ±</span>
          <span class="logo-subtitle">Smart Locker System</span>
        </div>
      </a>
      <div class="navbar-slogan">ğŸ³ é¤é¤é™ªä½ ï¼Œæº«æš–æ¯ä¸€å¤©</div>
      <div class="navbar-time" id="currentTime"></div>
    </div>
  </nav>

  <div class="container">
    <!-- æœå°‹å¡ç‰‡ -->
    <div class="search-card">
      <div class="search-header">
        <span>ğŸ”</span>
        <h2>è¨‚å–®æŸ¥è©¢</h2>
      </div>
      <div class="search-body">
        <div class="search-form">
          <div class="form-group">
            <label for="storeId">åº—è™Ÿ</label>
            <select id="storeId">
              <option value="">å…¨éƒ¨åº—å®¶</option>
              <option value="vm01">vm01åº—</option>
              <option value="vm02">vm02åº—</option>
            </select>
          </div>
          <div class="form-group">
            <label for="orderId">è¨‚å–®ç·¨è™Ÿ</label>
            <input type="text" id="orderId" placeholder="è¼¸å…¥ Order ID">
          </div>
          <div class="form-group">
            <label for="token">å–é¤ç¢¼</label>
            <input type="text" id="token" placeholder="è¼¸å…¥ Token">
          </div>
          <div class="form-group">
            <label for="chid">å­˜é¤æ ¼å£</label>
            <select id="chid">
              <option value="">å…¨éƒ¨æ ¼å£</option>
              <option value="1">æ ¼å£ 1</option>
              <option value="2">æ ¼å£ 2</option>
              <option value="3">æ ¼å£ 3</option>
              <option value="4">æ ¼å£ 4</option>
              <option value="5">æ ¼å£ 5</option>
              <option value="6">æ ¼å£ 6</option>
              <option value="7">æ ¼å£ 7</option>
              <option value="8">æ ¼å£ 8</option>
              <option value="9">æ ¼å£ 9</option>
              <option value="10">æ ¼å£ 10</option>
              <option value="11">æ ¼å£ 11</option>
              <option value="12">æ ¼å£ 12</option>
            </select>
          </div>
          <div class="form-group">
            <label for="dateFrom">é–‹å§‹æ—¥æœŸ</label>
            <input type="date" id="dateFrom">
            <select id="timeFrom" class="time-select">
              <option value="0">00:00</option>
              <option value="6" selected>06:00</option>
              <option value="7">07:00</option>
              <option value="8">08:00</option>
              <option value="9">09:00</option>
              <option value="10">10:00</option>
              <option value="11">11:00</option>
              <option value="12">12:00</option>
            </select>
          </div>
          <div class="form-group">
            <label for="dateTo">çµæŸæ—¥æœŸ</label>
            <input type="date" id="dateTo">
            <select id="timeTo" class="time-select">
              <option value="12">12:00</option>
              <option value="13">13:00</option>
              <option value="14">14:00</option>
              <option value="15" selected>15:00</option>
              <option value="18">18:00</option>
              <option value="21">21:00</option>
              <option value="23">23:59</option>
            </select>
          </div>
          <div class="form-group">
            <label>&nbsp;</label>
            <button class="btn btn-primary" onclick="searchOrders()" id="searchBtn">
              ğŸ” æŸ¥è©¢
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- è¨‚å–®æ¸…å–® -->
    <div class="result-card" id="orderListPanel">
      <div class="result-header">
        <h2>ğŸ“‹ æŸ¥è©¢çµæœ</h2>
        <div class="stats-bar" id="orderStats"></div>
      </div>
      <div class="result-body" id="orderListContent">
        <div class="message">è«‹è¼¸å…¥æŸ¥è©¢æ¢ä»¶å¾Œé»æ“Šã€ŒæŸ¥è©¢ã€</div>
      </div>
    </div>
    
    <!-- è¨‚å–®è©³æƒ… -->
    <div class="result-card" id="orderDetailPanel">
      <div class="detail-header">
        <button class="btn btn-secondary" onclick="backToList()">â† è¿”å›æ¸…å–®</button>
        <div class="detail-title" id="detailTitle"></div>
        <div class="detail-meta" id="detailMeta"></div>
      </div>
      <div class="result-header">
        <h2>â±ï¸ æ“ä½œæ™‚é–“è»¸</h2>
      </div>
      <div class="timeline-container" id="orderTimeline"></div>
    </div>
  </div>

  <footer class="footer">
    <p>Â© 2026 <a href="https://www.mwd.com.tw/" target="_blank">éº¥å‘³ç™»</a> My Warm Day - æ™ºå–æ«ƒè¨‚å–®æŸ¥è©¢ç³»çµ±</p>
  </footer>

  <script>
    const API_URL = '/graphql';
    let currentOrders = [];

    // æ›´æ–°æ™‚é–“
    function updateTime() {
      const now = new Date();
      document.getElementById('currentTime').textContent = now.toLocaleString('zh-TW', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        weekday: 'short',
        hour: '2-digit',
        minute: '2-digit'
      });
    }
    setInterval(updateTime, 1000);
    updateTime();
    
    // æ ¼å¼åŒ–æ™‚é–“æˆ³ï¼ˆå¾®ç§’ï¼‰
    function formatTimestamp(ts) {
      const ms = Math.floor(ts / 1000);
      const date = new Date(ms);
      return date.toLocaleString('zh-TW', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
    }
    
    function formatDate(ts) {
      const ms = Math.floor(ts / 1000);
      const date = new Date(ms);
      return date.toLocaleString('zh-TW', {
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
    }
    
    // æ—¥æœŸ+æ™‚é–“è½‰æ™‚é–“æˆ³
    function dateTimeToTimestamp(dateStr, hour, isEnd = false) {
      const date = new Date(dateStr);
      if (isEnd) {
        date.setHours(parseInt(hour), 59, 59, 999);
      } else {
        date.setHours(parseInt(hour), 0, 0, 0);
      }
      return date.getTime() * 1000;
    }
    
    // è£ç½®åç¨±
    function getDeviceName(deviceId, sm) {
      // æ ¼å£äº‹ä»¶
      if (sm === 'cabin' || !deviceId) {
        return { name: 'æ ¼å£', store: '', type: 'cabin' };
      }
      const devices = {
        '0242ac1e0008': { name: 'å–é¤æ©Ÿ', store: 'vm01', type: 'retriever' },
        '0242ac1c0002': { name: 'å­˜é¤æ©Ÿ', store: 'vm01', type: 'storer' },
        '0242ac230008': { name: 'å–é¤æ©Ÿ', store: 'vm02', type: 'retriever' },
        '0242ac220002': { name: 'å­˜é¤æ©Ÿ', store: 'vm02', type: 'storer' },
        '8c147dd48d02': { name: 'å­˜é¤æ©Ÿ', store: 'test', type: 'storer' },
        '8c147dd51bfe': { name: 'å–é¤æ©Ÿ', store: 'test', type: 'retriever' }
      };
      return devices[deviceId] || { name: deviceId, store: '?', type: 'unknown' };
    }
    
    // äº‹ä»¶èªªæ˜
    function getEventDescription(e, arg) {
      // æ ¼å£äº‹ä»¶ (cabin/XX)
      if (e.startsWith('cabin/')) {
        const cabinId = e.split('/')[1];
        const oldVal = arg?.old ?? '?';
        const newVal = arg?.new ?? '?';
        const changes = arg?.changes || '';
        return `ğŸšª æ ¼å£${cabinId} [${oldVal}â†’${newVal}] ${changes}`;
      }
      
      const descriptions = {
        'store/store_ok': 'âœ… å­˜é¤å®Œæˆ',
        'store/start': 'ğŸ“¦ é–‹å§‹å­˜é¤',
        'store/storing': 'â³ å­˜é¤ä¸­',
        'dispense/ready': 'ğŸ”“ æº–å‚™å–é¤',
        'dispense/prod_dispensed': 'ğŸ± å–é¤å®Œæˆ',
        'dispense/start': 'â–¶ï¸ é–‹å§‹å–é¤æµç¨‹',
        'dispose/dispose_ok': 'ğŸ—‘ï¸ è¨‚å–®åˆªé™¤',
        'dispose/start': 'ğŸ—‘ï¸ é–‹å§‹åˆªé™¤',
        'order/start': 'ğŸ“ è¨‚å–®é–‹å§‹',
        'order/hint': 'ğŸ’¡ è¨‚å–®æç¤º',
        'reader/read': 'ğŸ“– è®€å–è¼¸å…¥'
      };
      
      let desc = descriptions[e] || e;
      if (arg && arg.msg) {
        desc += ` - ${arg.msg}`;
      }
      return desc;
    }
    
    // æœå°‹è¨‚å–®
    async function searchOrders() {
      const storeId = document.getElementById('storeId').value;
      const orderId = document.getElementById('orderId').value.trim();
      const token = document.getElementById('token').value.trim();
      const chid = document.getElementById('chid').value;
      const dateFrom = document.getElementById('dateFrom').value;
      const timeFrom = document.getElementById('timeFrom').value;
      const dateTo = document.getElementById('dateTo').value;
      const timeTo = document.getElementById('timeTo').value;
      
      if (!storeId && !orderId && !token && !dateFrom && !chid) {
        alert('è«‹è‡³å°‘è¼¸å…¥ä¸€å€‹æŸ¥è©¢æ¢ä»¶');
        return;
      }
      
      const listPanel = document.getElementById('orderListPanel');
      const listContent = document.getElementById('orderListContent');
      const detailPanel = document.getElementById('orderDetailPanel');
      
      listPanel.classList.add('active');
      detailPanel.classList.remove('active');
      listContent.innerHTML = '<div class="message loading">â³ æŸ¥è©¢ä¸­...</div>';
      document.getElementById('searchBtn').disabled = true;
      
      try {
        const query = `
          query SearchOrders($storeId: String, $orderId: String, $token: String, $chid: String, $fromTs: Float, $toTs: Float) {
            orderList(storeId: $storeId, orderId: $orderId, token: $token, chid: $chid, fromTimestamp: $fromTs, toTimestamp: $toTs, limit: 100) {
              orderId
              storeId
              token
              chid
              storeTime
              dispenseTime
              isComplete
            }
          }
        `;
        
        const variables = {};
        
        // å¦‚æœæœ‰è¼¸å…¥è¨‚å–®ç·¨è™Ÿï¼Œå°±åªç”¨è¨‚å–®ç·¨è™ŸæŸ¥è©¢ï¼Œå¿½ç•¥å…¶ä»–æ¢ä»¶
        if (orderId) {
          variables.orderId = orderId;
        } else {
          if (storeId) variables.storeId = storeId;
          if (token) variables.token = token;
          if (chid) variables.chid = chid;
          if (dateFrom) variables.fromTs = dateTimeToTimestamp(dateFrom, timeFrom);
          if (dateTo) variables.toTs = dateTimeToTimestamp(dateTo, timeTo, true);
        }
        
        const response = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query, variables })
        });
        
        const result = await response.json();
        
        if (result.errors) {
          throw new Error(result.errors[0].message);
        }
        
        currentOrders = result.data.orderList || [];
        renderOrderList();
        
      } catch (err) {
        listContent.innerHTML = `<div class="message error">âŒ æŸ¥è©¢å¤±æ•—: ${err.message}</div>`;
      } finally {
        document.getElementById('searchBtn').disabled = false;
      }
    }
    
    // æ¸²æŸ“è¨‚å–®æ¸…å–®
    function renderOrderList() {
      const listContent = document.getElementById('orderListContent');
      const statsDiv = document.getElementById('orderStats');
      
      if (currentOrders.length === 0) {
        listContent.innerHTML = '<div class="message">æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„è¨‚å–®</div>';
        statsDiv.innerHTML = '';
        return;
      }
      
      const complete = currentOrders.filter(o => o.isComplete).length;
      const incomplete = currentOrders.length - complete;
      
      statsDiv.innerHTML = `
        <span class="stat-tag total">å…± ${currentOrders.length} ç­†</span>
        <span class="stat-tag complete">âœ… å·²å–é¤ ${complete}</span>
        <span class="stat-tag incomplete">â³ æœªå–é¤ ${incomplete}</span>
      `;
      
      let html = `
        <table class="order-table">
          <thead>
            <tr>
              <th>åº—è™Ÿ</th>
              <th>è¨‚å–®ç·¨è™Ÿ</th>
              <th>å–é¤ç¢¼</th>
              <th>æ ¼å£</th>
              <th>å­˜é¤æ™‚é–“</th>
              <th>å–é¤æ™‚é–“</th>
              <th>ç‹€æ…‹</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      currentOrders.forEach(order => {
        html += `
          <tr>
            <td><span class="badge store">${order.storeId || '-'}</span></td>
            <td><a class="order-link" onclick="showOrderDetail('${order.orderId}')">${order.orderId}</a></td>
            <td>${order.token ? `<span class="badge token">${order.token}</span>` : '-'}</td>
            <td>${order.chid ? `<span class="badge chid">${order.chid}</span>` : '-'}</td>
            <td>${order.storeTime ? formatDate(order.storeTime) : '-'}</td>
            <td>${order.dispenseTime ? formatDate(order.dispenseTime) : '-'}</td>
            <td>${order.isComplete 
              ? '<span class="badge complete">å·²å–é¤</span>' 
              : '<span class="badge incomplete">æœªå–é¤</span>'}</td>
          </tr>
        `;
      });
      
      html += '</tbody></table>';
      listContent.innerHTML = html;
    }
    
    // é¡¯ç¤ºè¨‚å–®è©³æƒ…
    async function showOrderDetail(orderId) {
      const listPanel = document.getElementById('orderListPanel');
      const detailPanel = document.getElementById('orderDetailPanel');
      const timeline = document.getElementById('orderTimeline');
      
      listPanel.classList.remove('active');
      detailPanel.classList.add('active');
      timeline.innerHTML = '<div class="message loading">â³ è¼‰å…¥ä¸­...</div>';
      
      try {
        const query = `
          query GetOrderTimeline($orderId: String!) {
            orderTimeline(orderId: $orderId) {
              orderId
              token
              chid
              events {
                timestamp
                e
                arg
                sm
                trigger
                st
                deviceId
              }
            }
          }
        `;
        
        const response = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query, variables: { orderId } })
        });
        
        const result = await response.json();
        
        if (result.errors) {
          throw new Error(result.errors[0].message);
        }
        
        const order = result.data.orderTimeline[0];
        
        if (!order) {
          timeline.innerHTML = '<div class="message">æ‰¾ä¸åˆ°è¨‚å–®è³‡æ–™</div>';
          return;
        }
        
        document.getElementById('detailTitle').textContent = `è¨‚å–® #${order.orderId}`;
        document.getElementById('detailMeta').innerHTML = `
          ${order.token ? `<span class="badge token">å–é¤ç¢¼: ${order.token}</span>` : ''}
          ${order.chid ? `<span class="badge chid">æ ¼å£: ${order.chid}</span>` : ''}
        `;
        
        renderTimeline(order.events);
        
      } catch (err) {
        timeline.innerHTML = `<div class="message error">âŒ è¼‰å…¥å¤±æ•—: ${err.message}</div>`;
      }
    }
    
    // æ ¼å¼åŒ–æ™‚é–“å·®ç‚º HH:MM:SS
    function formatTimeDiff(diffMs) {
      const totalSeconds = Math.floor(diffMs / 1000);
      const hours = Math.floor(totalSeconds / 3600);
      const minutes = Math.floor((totalSeconds % 3600) / 60);
      const seconds = totalSeconds % 60;
      return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }
    
    // æ¸²æŸ“æ™‚é–“è»¸
    function renderTimeline(events) {
      const timeline = document.getElementById('orderTimeline');
      
      if (!events || events.length === 0) {
        timeline.innerHTML = '<div class="message">æ²’æœ‰æ“ä½œè¨˜éŒ„</div>';
        return;
      }
      
      let html = '<div class="timeline">';
      
      events.forEach((event, index) => {
        const device = getDeviceName(event.deviceId, event.sm);
        const isCabin = event.sm === 'cabin';
        
        html += `
          <div class="timeline-item">
            <div class="timeline-dot ${device.type}"></div>
            <div class="timeline-content ${device.type}">
              <div class="timeline-time">${formatTimestamp(event.timestamp)}</div>
              <div class="timeline-event">
                ${getEventDescription(event.e, event.arg)}
                ${!isCabin ? `<span class="device ${device.type}">${device.name}</span>` : ''}
              </div>
              ${!isCabin ? `<div class="timeline-state">ç‹€æ…‹: ${event.st || '-'} â†’ ${event.sm}/${event.trigger}</div>` : ''}
            </div>
          </div>
        `;
        
        // é¡¯ç¤ºèˆ‡ä¸‹ä¸€å€‹äº‹ä»¶çš„æ™‚é–“å·®
        if (index < events.length - 1) {
          const nextEvent = events[index + 1];
          const diffMs = Math.floor((nextEvent.timestamp - event.timestamp) / 1000); // å¾®ç§’è½‰æ¯«ç§’
          if (diffMs > 0) {
            html += `<div class="timeline-gap">+${formatTimeDiff(diffMs)}</div>`;
          }
        }
      });
      
      html += '</div>';
      timeline.innerHTML = html;
    }
    
    // è¿”å›æ¸…å–®
    function backToList() {
      document.getElementById('orderListPanel').classList.add('active');
      document.getElementById('orderDetailPanel').classList.remove('active');
    }
    
    // è¨­å®šé è¨­æ—¥æœŸ
    const today = new Date();
    const weekAgo = new Date(today);
    weekAgo.setDate(weekAgo.getDate() - 7);
    
    document.getElementById('dateTo').value = today.toISOString().split('T')[0];
    document.getElementById('dateFrom').value = weekAgo.toISOString().split('T')[0];
    
    // Enter éµæœå°‹
    document.querySelectorAll('input').forEach(input => {
      input.addEventListener('keypress', e => {
        if (e.key === 'Enter') searchOrders();
      });
    });
    
    // åˆå§‹é¡¯ç¤ºæ¸…å–®é¢æ¿
    document.getElementById('orderListPanel').classList.add('active');
  </script>
</body>
</html>
